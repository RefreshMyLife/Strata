/** @jsxImportSource @emotion/react */
import { Dialog, DialogContent, IconButton, Typography } from '@mui/material';
import React, { useState } from 'react';
import { NoticeError, Spinner } from 'src/components';

import referralBgBox from 'src/assets/img/background/referral_bg_box.png';
import { ReactComponent as CloseIcon } from 'src/assets/img/icons/close.svg';
import { ReactComponent as CopyIcon } from 'src/assets/img/icons/copy.svg';
import { useGetRefCode } from 'src/clients/api/queries/getPoints/getPointsStats';
import { useAuth } from 'src/context/AuthContext';

import { useStyles } from './inviteFriendDialogStyles';

interface InviteFriendDialogProps {
    isOpen: boolean;
    onClose: () => void;
    referralLink?: string;
}

export const InviteFriendDialog: React.FC<InviteFriendDialogProps> = ({ isOpen, onClose }) => {
    const { accountAddress } = useAuth();
    const { data: account, isLoading, isError, error } = useGetRefCode({ accountAddress });
    const styles = useStyles();
    const [showToast, setShowToast] = useState(false);
    const referralLink = isLoading ? null : `https://${window.location.host}${account?.url}`;
    const hasError = isError || (!isLoading && account == null);

    const handleCopyLink = () => {
        navigator.clipboard.writeText(referralLink);
        setShowToast(true);
        setTimeout(() => setShowToast(false), 3000); // Hide after 3 seconds
    };

    return (
        <Dialog
            open={isOpen}
            onClose={onClose}
            maxWidth={false}
            sx={theme => ({
                [theme.breakpoints.down('sm')]: {
                    alignItems: 'flex-end',
                },
            })}
            PaperProps={{
                sx: theme => ({
                    background: `url(${referralBgBox})`,
                    backgroundSize: 'cover',
                    backgroundPosition: 'center',
                    backgroundRepeat: 'no-repeat',
                    border: '1px solid rgba(255, 255, 255, 0.08)',
                    borderRadius: '20px',
                    boxShadow: '0px 0px 10px 0px rgba(32, 175, 253, 0.1) inset',
                    width: '440px',
                    maxWidth: 'calc(100vw - 40px)',
                    maxHeight: 'calc(100vh - 40px)',
                    margin: 0,
                    [theme.breakpoints.down('sm')]: {
                        width: '100vw',
                        height: '61vh',
                        maxWidth: '100vw',
                        maxHeight: '61h',
                        margin: 0,
                        borderBottomLeftRadius: 0,
                        borderBottomRightRadius: 0,
                        alignSelf: 'end',
                    },
                }),
            }}
            slotProps={{
                backdrop: {
                    sx: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        backdropFilter: 'blur(4px)',
                    },
                },
            }}
        >
            <DialogContent css={styles.dialogContent}>
                <IconButton css={styles.closeButton} onClick={onClose}>
                    <CloseIcon width="16" height="16" />
                </IconButton>

                <div css={styles.content}>
                    {/* User Icon */}
                    <div css={styles.iconContainer}>
                        <svg
                            width="90"
                            height="90"
                            viewBox="0 0 90 90"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <rect width="90" height="90" rx="45" fill="#1A2229" />
                            <path
                                opacity="0.3"
                                fill-rule="evenodd"
                                clip-rule="evenodd"
                                d="M32.9036 9.98093C37.4385 8.41055 42.1456 7.77653 46.7738 8.00827C46.9024 8.01435 47.0309 8.02233 47.1595 8.02975C47.2093 8.03277 47.2591 8.03533 47.3089 8.03854C48.8797 8.1356 50.4509 8.33293 52.013 8.63425V8.63229C55.112 9.22911 58.0705 10.2189 60.8411 11.5395C60.8727 11.5545 60.9043 11.5694 60.9359 11.5844C61.0439 11.6363 61.1516 11.6888 61.2591 11.7417C65.6342 13.8789 69.6209 16.8919 72.9251 20.7065H72.9212C74.0877 22.0509 75.1694 23.4949 76.1527 25.0356C76.1867 25.0888 76.2185 25.1434 76.2523 25.1967C76.3642 25.374 76.4742 25.553 76.5833 25.7329C76.5977 25.7566 76.612 25.7804 76.6263 25.8042C76.7022 25.9299 76.7781 26.0562 76.8529 26.1831C76.9407 26.3318 77.0288 26.4803 77.1146 26.6303C77.2889 26.9358 77.4587 27.2429 77.6234 27.5512C78.7056 29.5756 79.6064 31.7113 80.3011 33.938L80.3119 33.9721C80.3489 34.0905 80.3855 34.209 80.4212 34.3276C80.4398 34.3896 80.4586 34.452 80.4769 34.5141C80.5266 34.6826 80.5733 34.8521 80.6204 35.021C80.6373 35.0816 80.6556 35.1419 80.6722 35.2026L80.7708 35.5688C80.79 35.6419 80.8078 35.7154 80.8265 35.7885C80.855 35.9003 80.8839 36.0123 80.9115 36.1245C80.9548 36.3006 80.9967 36.4773 81.0374 36.6538C81.0545 36.7279 81.0726 36.8021 81.0892 36.8764C81.1329 37.0714 81.1748 37.267 81.2152 37.4624C81.2263 37.5166 81.2365 37.5711 81.2474 37.6255C81.2657 37.7161 81.2815 37.8072 81.2992 37.8979C81.3214 38.0121 81.3434 38.1264 81.3646 38.2407C81.383 38.3406 81.4008 38.4405 81.4183 38.5405C81.4489 38.7139 81.4781 38.8874 81.5062 39.061C81.5163 39.1238 81.5267 39.1866 81.5365 39.2495C81.7461 40.5887 81.8819 41.9324 81.9427 43.2749C81.9473 43.3728 81.9497 43.4708 81.9535 43.5688C81.962 43.7973 81.9648 44.0261 81.9691 44.2544C81.9741 44.5025 81.9767 44.7511 81.9769 44.9995H81.973C81.9725 45.1665 81.9707 45.3335 81.9681 45.5005C81.9643 45.7682 81.959 46.0359 81.9495 46.3022C81.9446 46.4354 81.9403 46.5686 81.9339 46.7016C81.6681 52.4433 80.0856 57.8413 77.4915 62.6098C77.364 62.8454 77.2376 63.0819 77.1048 63.3149C77.0202 63.4626 76.9329 63.6091 76.846 63.7553L76.8119 63.8139C74.8234 67.1805 72.2877 70.2629 69.2357 72.9067L69.2308 72.8969C64.4197 77.0791 58.5196 80.0403 52.012 81.2934L52.013 81.2866C49.6842 81.7389 47.3359 81.9586 44.9993 81.9575V81.9614C44.7652 81.9607 44.5312 81.9582 44.2972 81.9536C44.0396 81.949 43.7815 81.946 43.5238 81.936C43.4484 81.933 43.3725 81.9307 43.2972 81.9272C42.8133 81.9054 42.3291 81.8735 41.8451 81.8325C41.8306 81.8312 41.8156 81.8318 41.8011 81.8305C40.1076 81.685 38.4162 81.4165 36.7376 81.0307C36.5666 80.9919 36.396 80.9518 36.2259 80.9106C36.1648 80.8957 36.1034 80.882 36.0423 80.8667C33.2039 80.164 30.4951 79.1342 27.9583 77.8188C27.8711 77.7738 27.7845 77.7269 27.6976 77.6811C27.4956 77.5743 27.2967 77.4624 27.097 77.352C26.9571 77.275 26.818 77.1954 26.679 77.1167C26.6238 77.0853 26.5681 77.0546 26.513 77.0229C26.4913 77.0104 26.4693 76.9983 26.4476 76.9858V76.9839C24.4286 75.8183 22.5085 74.4573 20.722 72.9048L20.7201 72.9116C15.7107 68.5724 12.0836 63.0555 10.0081 57.0278L9.9974 57.0366C8.6856 53.2482 8.03396 49.3388 7.98665 45.4565C7.98309 45.2076 7.97933 44.9586 7.98079 44.7094C7.98258 44.4874 7.98967 44.2652 7.99544 44.0434C8.1262 38.5772 9.46265 33.069 12.1331 27.9292C12.1622 27.8731 12.1937 27.8181 12.223 27.7622C12.4015 27.4229 12.5866 27.0854 12.7767 26.7495C12.8268 26.6606 12.8774 26.5715 12.9281 26.4829L12.9261 26.4819C13.0438 26.2793 13.1635 26.0779 13.2845 25.8774C13.4173 25.6565 13.5492 25.4346 13.6868 25.2163C13.7272 25.1526 13.7673 25.0883 13.8079 25.0249C14.0687 24.6168 14.3381 24.2135 14.6156 23.8149C14.6239 23.803 14.6307 23.7897 14.639 23.7778C14.7571 23.6085 14.8792 23.4413 15.0003 23.2739C15.0103 23.2601 15.0196 23.2457 15.0296 23.2319C15.1704 23.0379 15.3145 22.8462 15.4593 22.6548C15.509 22.5889 15.5586 22.523 15.6087 22.4575C15.7238 22.3074 15.8398 22.1578 15.9574 22.0092C16.042 21.902 16.1273 21.7953 16.2132 21.6889C16.3051 21.5756 16.3973 21.4624 16.4906 21.3501C16.6291 21.1828 16.7697 21.0171 16.9115 20.852C16.9578 20.7982 17.0044 20.7445 17.0511 20.6909C17.2866 20.4198 17.5247 20.1501 17.7689 19.8852L17.7933 19.8589C17.8773 19.7676 17.9614 19.6766 18.0462 19.5864C18.0906 19.5394 18.1354 19.4926 18.18 19.4458C18.3011 19.3184 18.4245 19.1932 18.5472 19.0678C18.5914 19.0227 18.6345 18.976 18.679 18.9311L18.9466 18.6635C19.0003 18.6103 19.0557 18.5582 19.1097 18.5053C19.1923 18.4247 19.2743 18.3431 19.3577 18.2632C19.4886 18.1375 19.6208 18.0136 19.7533 17.8901C19.809 17.8383 19.8642 17.7854 19.9202 17.7339C20.0673 17.5985 20.2156 17.4642 20.3646 17.3315C20.4059 17.2947 20.448 17.2587 20.4896 17.2221C21.922 15.9579 23.4428 14.8188 25.0326 13.8042C26.5779 12.8126 28.2024 11.9344 29.8939 11.1782C29.927 11.1634 29.9603 11.149 29.9935 11.1342C30.7333 10.8061 31.4857 10.501 32.2503 10.2212C32.4147 10.1608 32.5796 10.1023 32.7445 10.0444C32.7991 10.0253 32.8537 10.0047 32.9085 9.98581L32.9036 9.98093ZM46.8978 11.4204C40.8391 11.0788 34.8003 12.3875 29.4476 15.1714C29.0225 15.3934 28.5993 15.6265 28.18 15.8686C27.8705 16.0473 27.5646 16.2295 27.263 16.4165C24.1184 18.3722 21.3203 20.8326 18.9818 23.6841C17.8185 25.1059 16.781 26.612 15.8753 28.185L15.8724 28.1831C14.9367 29.8059 14.1566 31.4763 13.5179 33.1743C12.2421 36.5845 11.5223 40.1914 11.3968 43.8462C11.1165 52.4874 14.1863 61.0326 20.0872 67.5395H20.0921C22.458 70.1518 25.1845 72.3281 28.1478 74.0395L28.1497 74.0376C32.9193 76.7902 38.3033 78.3337 43.7962 78.5337C44.1914 78.5474 44.5862 78.5554 44.9808 78.5551C48.4139 78.559 51.8756 78.0388 55.2425 76.9555L55.2464 76.9575C61.935 74.8103 67.7112 70.6339 71.8411 65.145C75.9293 59.6962 78.2477 53.1418 78.5443 46.4087C78.564 45.9417 78.574 45.4712 78.5745 44.9995H78.5726C78.5714 38.1206 76.4566 31.3548 72.4935 25.687C71.9914 24.9706 71.4658 24.2787 70.9183 23.6118C68.7509 20.9815 66.1905 18.6874 63.3275 16.8169C62.6701 16.3888 61.9996 15.9845 61.3167 15.6049C60.6302 15.2237 59.9315 14.867 59.222 14.5356C59.1979 14.5243 59.1739 14.5127 59.1497 14.5014C55.3011 12.7147 51.1393 11.6672 46.8978 11.4204Z"
                                fill="white"
                            />
                            <path
                                d="M33.418 35.6411C33.418 31.8442 36.496 28.7661 40.293 28.7661C44.0899 28.7661 47.168 31.8442 47.168 35.6411C47.168 39.4381 44.0899 42.5161 40.293 42.5161C36.496 42.5161 33.418 39.4381 33.418 35.6411Z"
                                fill="white"
                            />
                            <path
                                d="M28.418 56.8911C28.418 50.3327 33.7346 45.0161 40.293 45.0161C46.8514 45.0161 52.168 50.3327 52.168 56.8911V56.8954C52.1679 56.9617 52.1674 57.0284 52.1663 57.0943C52.159 57.5252 51.9304 57.9219 51.5612 58.1442C48.2691 60.1263 44.4123 61.2661 40.293 61.2661C36.1737 61.2661 32.3168 60.1263 29.0247 58.1442C28.6556 57.9219 28.4269 57.5252 28.4197 57.0943C28.4185 57.0268 28.418 56.959 28.418 56.8911Z"
                                fill="white"
                            />
                            <path
                                d="M55.918 37.5161C55.918 36.8258 55.3583 36.2661 54.668 36.2661C53.9776 36.2661 53.418 36.8258 53.418 37.5161V41.2661H49.668C48.9776 41.2661 48.418 41.8258 48.418 42.5161C48.418 43.2065 48.9776 43.7661 49.668 43.7661H53.418V47.5161C53.418 48.2065 53.9776 48.7661 54.668 48.7661C55.3583 48.7661 55.918 48.2065 55.918 47.5161V43.7661H59.668C60.3583 43.7661 60.918 43.2065 60.918 42.5161C60.918 41.8258 60.3583 41.2661 59.668 41.2661H55.918V37.5161Z"
                                fill="white"
                            />
                        </svg>
                    </div>

                    {/* Title */}
                    <Typography variant="h4" css={styles.title}>
                        Refer to Friends
                    </Typography>

                    {/* Description */}
                    <Typography variant="body1" css={styles.description}>
                        Share the referral link with your friends and earn{' '}
                        <span css={styles.highlight}>10%</span> of total Strata Points earned by
                        them. They'll receive a <span css={styles.highlight}>10% boost</span> on
                        their Strata Points.
                    </Typography>

                    {/* Referral Link Input */}
                    {isLoading && <Spinner />}
                    {hasError && <NoticeError description={'Link not properly loaded'} />}
                    {!isLoading && !hasError && (
                        <div css={styles.linkContainer}>
                            <input
                                type="text"
                                value={referralLink}
                                readOnly
                                css={styles.linkInput}
                            />
                            <div css={styles.copyButton} onClick={handleCopyLink}>
                                <svg
                                    width="16"
                                    height="17"
                                    viewBox="0 0 16 17"
                                    fill="none"
                                    xmlns="http://www.w3.org/2000/svg"
                                >
                                    <path
                                        d="M0 2.75C0 1.50736 1.00736 0.5 2.25 0.5H8.75C9.99264 0.5 11 1.50736 11 2.75V4H7.25C5.17893 4 3.5 5.67893 3.5 7.75V11.5H2.25C1.00736 11.5 0 10.4926 0 9.25V2.75Z"
                                        fill="#90A0AC"
                                        fill-opacity="0.5"
                                    />
                                    <path
                                        d="M7.25 5.5C6.00736 5.5 5 6.50736 5 7.75V14.25C5 15.4926 6.00736 16.5 7.25 16.5H13.75C14.9926 16.5 16 15.4926 16 14.25V7.75C16 6.50736 14.9926 5.5 13.75 5.5H7.25Z"
                                        fill="#90A0AC"
                                        fill-opacity="0.5"
                                    />
                                </svg>
                            </div>
                        </div>
                    )}
                </div>

                {/* Toast Notification */}
                {showToast && (
                    <div css={styles.toast}>
                        <div css={styles.toastContent}>
                            <svg
                                width="16"
                                height="16"
                                viewBox="0 0 16 16"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <path
                                    fill-rule="evenodd"
                                    clip-rule="evenodd"
                                    d="M8 16C12.4183 16 16 12.4183 16 8C16 3.58172 12.4183 0 8 0C3.58172 0 0 3.58172 0 8C0 12.4183 3.58172 16 8 16ZM11.8566 6.19113C12.1002 5.85614 12.0261 5.38708 11.6911 5.14345C11.3561 4.89982 10.8871 4.97388 10.6434 5.30887L7.15969 10.099L5.28033 8.21967C4.98744 7.92678 4.51256 7.92678 4.21967 8.21967C3.92678 8.51256 3.92678 8.98744 4.21967 9.28033L6.71967 11.7803C6.87477 11.9354 7.08999 12.0149 7.30867 11.9977C7.52734 11.9805 7.72754 11.8685 7.85655 11.6911L11.8566 6.19113Z"
                                    fill="#3BEF80"
                                />
                            </svg>
                            <span>Link copied!</span>
                        </div>
                    </div>
                )}
            </DialogContent>
        </Dialog>
    );
};
